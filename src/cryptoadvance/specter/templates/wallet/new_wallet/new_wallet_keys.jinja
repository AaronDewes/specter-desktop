{% extends "base.jinja" %}

{% block main %}
	<form id="keysform" action="./" method="POST" onsubmit="showPacman()" class="table-holder">

		<input type="hidden" class="csrf-token" name="csrf_token" value="{{ csrf_token() }}"/>

		<h1>{{ _("Configure your Wallet") }}</h1>

		<input type="text" id="wallet_name" name="wallet_name" class="inline" value="{{ wallet_name }}" placeholder="My new wallet" required>

		{% set enable_taproot = (wallet_type == 'simple' and specter.taproot_support and cosigners[0].taproot_support) %}

		<nav class="text-center text-dark-200 border-b border-dark-600">
			<ul class="flex flex-wrap -mb-px">
				<li aria-checked="{% if not specter.price_provider %}true{% endif %}" class="mr-2 py-2 border-b-2 border-transparent aria-checked:text-link aria-checked:border-b-2 aria-checked:border-link" id="manual_menu_item">
					<label>
						<input type="radio" name="type" value="{{'sh-wsh' if wallet_type == 'multisig' else 'sh-wpkh'}}" class="hidden" onchange="updateType(this.value);">
						<div class="text-lg inline-block py-1 px-3 hover:text-white rounded-lg hover:bg-dark-700" id="type_nested_segwit_btn">{{ _("Nested Segwit") }}</div>
					</label>
				</li>

				<li aria-checked="{% if not specter.price_provider %}true{% endif %}" class="mr-2 py-2 border-b-2 border-transparent aria-checked:text-link aria-checked:border-b-2 aria-checked:border-link" id="manual_menu_item">
					<label>
						<input type="radio" name="type" value="{{'wsh' if wallet_type == 'multisig' else 'wpkh'}}" checked class="hidden type_nested_segwit" onchange="updateType(this.value);">
						<div class="text-lg inline-block py-1 px-3 hover:text-white rounded-lg hover:bg-dark-700" id="type_native_segwit_btn">{{ _("Segwit") }}</div>
					</label>
				</li>
				{% if enable_taproot %}
					<li aria-checked="false" class="mr-2 py-2 border-b-2 border-transparent aria-checked:text-link aria-checked:border-b-2 aria-checked:border-link" id="manual_menu_item">
						<label>
							<input type="radio" name="type" value="tr" class="hidden" onchange="updateType(this.value);">
							<div class="text-lg inline-block py-1 px-3 hover:text-white rounded-lg hover:bg-dark-700" id="type_taproot_btn">{{ _("Taproot") }}</div>
						</label>
					</li>
				{% endif %}
			</ul>
		</nav>

		<div class="flex p-4 mt-3 mb-4 bg-dark-600 rounded-lg" role="alert">
			<svg class="flex-shrink-0 inline w-6 h-6 mr-3" version="1.1" viewBox="0 0 64 64" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink"><!--Generated by IJSVG (https://github.com/iconjar/IJSVG)--><path d="M32.0022,55.9844l-1.04907e-06,-2.84217e-14c-13.2548,-5.79387e-07 -24,-10.7452 -24,-24c5.79387e-07,-13.2548 10.7452,-24 24,-24c13.2548,5.79387e-07 24,10.7452 24,24l2.13163e-14,-1.04907e-06c0,13.2548 -10.7452,24 -24,24Zm1.5,-32l3.82016e-08,-2.71086e-09c-1.79133,0.127116 -3.35165,-1.21031 -3.5,-3l6.50646e-08,-7.8524e-07c0.148296,-1.78972 1.70866,-3.12717 3.5,-3l-5.85322e-09,4.15529e-10c1.79134,-0.127171 3.3517,1.21028 3.5,3l-5.57104e-08,6.72365e-07c-0.148295,1.78976 -1.70872,3.12723 -3.5001,3Zm1.4206,6.7635l-2.7853,10.5093l-8.37179e-08,3.15667e-07c-0.270677,1.02062 0.262417,2.08281 1.2425,2.4757l-5.91015e-08,-2.36708e-08c0.379505,0.151996 0.628277,0.519688 0.6282,0.9285v0.323l8.52651e-14,4.05e-07c0,0.551933 -0.447167,0.999503 -0.9991,1h-2.9891l-4.04477e-08,1.96948e-10c-1.65938,0.00807986 -3.01111,-1.33056 -3.01919,-2.98993c-0.00127082,-0.260991 0.0314695,-0.521035 0.0973943,-0.773566l2.7852,-10.5094l2.79671e-08,-1.05468e-07c0.270652,-1.02067 -0.262537,-2.08289 -1.2427,-2.4757l-2.20542e-08,-8.83296e-09c-0.379505,-0.151996 -0.628276,-0.519688 -0.6282,-0.9285v-0.3229l-1.77636e-14,-9.40042e-08c-8.33514e-08,-0.552011 0.447289,-0.999614 0.9993,-1h2.9887l1.06497e-07,-5.28143e-10c1.65943,-0.00822943 3.01133,1.33033 3.01956,2.98976c0.00129458,0.261047 -0.0314356,0.52115 -0.0973639,0.773738Z" fill="currentColor" fill-rule="evenodd"></path></svg>
			<span class="sr-only">Info</span>
			<div>
				<span class="font-medium">Info: </span> 
				<b>{{ _("Segwit")}}</b>{{ _(" uses bech32-encoded addresses (bc1), ")}}<b>{{ _("Nested Segwit")}}</b>{{ _(" makes it compatible with legacy software. Don't use legacy.")}}
			</div>
		</div>

		{% if wallet_type == 'multisig' %}
			<div class="center">
				{{ _("Using") }} 
				<input class="inline" type="number" name="sigs_required" min=1 max="{{ cosigners | length }}" step=1 value="{{ sigs_required }}" />
				{{ _("of") }} 
				<span data-style="margin: 0px 40px; font-size: 1.2em;">{{ cosigners | length }}<span>
			</div>
		{% endif %}

		
		{% for cosigner in cosigners %}
			<input type="hidden" name="cosigner{{ loop.index0 }}" value="{{ cosigner.alias }}"/>
		{% endfor %}

		<input type="hidden" name="sigs_total" value="{{ cosigners | length }}">
		{% for device in cosigners %}
			<h3 class="mt-5">{{ _("Signer") }} {{ loop.index }} - {{ device.name }}</h3>
			{% set outer_loop = loop %}
			{% if device.keys | length > 0 %}
				<div class="table-holder">
					<table>
						<thead>
							<tr>
								<th>{{ _("Network") }}</th>
								<th>{{ _("Purpose") }}</th>
								<th class="optional">{{ _("Derivation") }}</th>
								<th class="optional">{{ _("Key") }}</th>
								<th>{{ _("Actions") }}</th>
							</tr>
						</thead>
						<tbody id="device{{ loop.index0 }}">
							{% for key in device.keys if key.is_testnet == specter.is_testnet %}
								<tr>
									<td>
										{% include "components/network_label.jinja" %}
									</td>
									<td>{{ key.purpose }}</td>
									<td class="optional">{{ key.derivation }}</td>
									<td class="scroll xpub optional"><span>{{ key.original }}</span></td>
									<td width="120px">
										<label>
											<input class="device-key hidden" data-key-types="{{key.key_type}}" type="radio" name="key{{ outer_loop.index0 }}" value="{{ key.original }}" {% if loop.index == 1 %}checked{% endif %}/>
											<div class="btn inline hovering">{{ _("Use this key") }}</div>
										</label>
									</td>
								</tr>
							{% endfor %}
							<tr class="hidden">
								<td>
								{{ _("The device does not have keys matching the wallet type selected.") }}
								</td>
								<td>
								{{ _("Please choose a different type or add the keys to the device...") }}
								</td>
								<td>
								</td>
								<td>
								</td>
								<td>
								</td>
							</tr>
						</tbody>
					</table>
				</div>
			{% else %}
				<div class="center">{{ _("Looks like this device doesn't have keys matching this type of wallet.") }}</div>
			{% endif %}			
			<div class="spacer"></div>
		{% endfor %}

		<div data-style="display: flex; flex-direction: column; align-items: center; gap: 10px; max-width: 500px; margin: auto;">
			<div data-style="display: flex; gap: 3px; margin-top: 10px;">
				<input form="keysform" type="checkbox" name="rescanblockchain" id="rescan" class="inline" onchange="toggleScanOptions(this)">
				<label for="rescan">{{ _("Scan for existing funds?") }}</label>
				<tool-tip width="200px">
            		<span slot="paragraph">
						{{ _("Check this option if the wallet has past transactions: the blockchain will be scanned for those and the wallet balance will be calculated.") }}      
            		</span>
        		</tool-tip>
			</div>
			<div id="scan-options" class="hidden" data-style="text-align: center;">
				<br>
				<div data-style="display: flex; justify-content: center">
					{{ _("Rescan type:") }} 
					<label><input type="radio" class="inline" data-style="margin: 0 10px 0 20px;" name="full_rescan_option" value="full" onclick="toggleFullRescanOption(this)" checked>{{ _("Full rescan") }}</label>
					<label><input type="radio" class="inline" data-style="margin: 0 10px 0 20px" name="full_rescan_option" value="utxo" onclick="toggleFullRescanOption(this);">{{ _("UTXO only") }}</label>
					<tool-tip width="200px">
            			<span slot="paragraph">
							{{ _("Full rescan is a slow process which searches for and imports the full wallet transaction history and balance.") }}<br>
							{{ _("UTXO only is fast and looks only for existing balances (UTXO) and will not import the full transaction history.") }}
            			</span>
        			</tool-tip>
				</div>
				<br>
				<div id="full-scan-options">
					{% if specter.info.chain == "main" %}
						{% set startblock=(481824 if not specter.info['pruned'] or specter.info['pruneheight'] < 481824 else specter.info['pruneheight']) %}
					{% else %}
						{% set startblock=(0 if not specter.info['pruned'] else specter.info['pruneheight']) %}
					{% endif %}
					{{ _("Rescan blockchain from block:") }} <input type="number" name="startblock" value="{{startblock}}" min="{{startblock}}" data-style="max-width: 150px; margin-left: 5px;">
					{% if specter.info['pruned']  %}
						<span class="warning" data-style="display: inline-block; max-width:300px;">
							<img src="{{ url_for('static', filename='img/info_sign.svg') }}" data-style="width: 20px;"/><br>{{ _("You are using a pruned node.")}}<br>{{ _("Wallet history may not fully appear.")}}<br>{{ _("Rescan is limited by the pruned height to block:") }} {{specter.info['pruneheight']}}
						</span>
					{% endif %}
					<div class="note center" data-style="margin-top: 5px; line-height: 2;">{{ _("In case you're not sure, it is best to just leave the default number.")}}<br><b>481824</b>{{ _(" was the first Segwit block.")}}</div>
					<br>
				</div>
				<div id="utxo-scan-options" data-style="display: none">
					{% if specter.info['pruned']  %}
						<label for="use_explorer"><input data-style="width: auto; min-width: auto;" type="checkbox" id="use_explorer" name="use_explorer" checked> {{ _("Fetch missing data from block explorer") }}
							<span class="warning" id="utxo-warning" data-style="display: inline-block; max-width:300px;">
								{{ _("You are using a pruned node. Blocks for some transactions may be missing.") }}
								{{ _("Check this checkbox if you want to fetch missing information from a block explorer.") }}
							</span>
						</label>
						<div id="utxo-explorer">
							<br>
							{{ _("Block explorer URL:") }}
							{% include "components/explorer_select.jinja" %}
							<span class="warning" id="utxo-warning" data-style="display: inline-block; max-width:300px;">
							<img src="{{ url_for('static', filename='img/info_sign.svg') }}" data-style="width: 20px;"/><br>{{ _("Careful with block explorers!") }}<br>
							{{ _("This may have privacy implications!") }}<br>
							{{ _("Information fetched from the block explorer contains a list of unspent transactions of your wallet from old (pruned) blocks.") }}<br>
							{{ _('"They" will know what transactions you are interested in.') }}
						</span>
					</div>
					{% endif %}
				</div>
			</div>
		</div>

		<button type="submit" name="action" value="key" class="btn centered action">{{ _("Create wallet") }}</button>
	</form>
{% endblock %}

{% block scripts %}
	<script>
		function updateType(val){
			let keys = document.getElementsByClassName('device-key');
			let allDevices = [];
			let devicesWithExistingKeys = [];
			for (let i = keys.length - 1; i >= 0; i--) {
				let key = keys[i];
				let type = key.getAttribute('data-key-types');
				key.disabled = !(type == "" || type == val);
				allDevices.push(key.parentNode.parentNode.parentNode.parentNode.id)
				if(key.disabled){
					key.checked = false;
					key.parentNode.parentNode.parentNode.classList.add('hidden');
				} else {
					key.checked = true;
					key.parentNode.parentNode.parentNode.classList.remove('hidden');
					devicesWithExistingKeys.push(key.parentNode.parentNode.parentNode.parentNode.id)
				}
			}

			for (let device of allDevices) {
				let deviceHTML = document.getElementById(device)
				if (devicesWithExistingKeys.indexOf(device) == -1) {
					deviceHTML.children[deviceHTML.children.length - 1].classList.remove('hidden')
				} else {
					deviceHTML.children[deviceHTML.children.length - 1].classList.add('hidden')
				}
			}
		}
		// initial trigger
		let els = document.getElementsByName("type");
		els.forEach(el=>{
			if (el.checked){
				updateType(el.value);
			}
		})
		function toggleScanOptions(scanCheckbox) {
			let scanOptions = document.getElementById('scan-options');
			if (scanCheckbox.checked) {
				scanOptions.style.display = 'block';
			} else {
				scanOptions.style.display = 'none';
			}
		}

		function toggleFullRescanOption(scanOption) {
			let scanOptions = document.getElementById('full-scan-options');
			let utxoOptions = document.getElementById('utxo-scan-options');
			if (scanOption.value == 'full') {
				scanOptions.style.display = 'block';
				utxoOptions.style.display = 'none';
			} else {
				scanOptions.style.display = 'none';
				utxoOptions.style.display = 'block';
			}
		}
		let utxocheckbox = document.getElementById("use_explorer");
		if(utxocheckbox){
			utxocheckbox.addEventListener('change', e=>{
				let el = document.getElementById("utxo-explorer")
				if(utxocheckbox.checked){
					el.style.display = "inline-block";
				}else{
					el.style.display = "none";
				}
			});
		}
	</script>
{% endblock%}
